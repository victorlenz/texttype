/**
 * Available for use under the MIT License (http://en.wikipedia.org/wiki/MIT_License)
 * 
 * Copyright (c) 2014 - 2015 by Adam Banaszkiewicz
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 * @version 0.3.1
 * @date    2015.12.14
 * @author  Adam Banaszkiewicz
 */
!function(i){document.getWindowWidth=function(){return"number"==typeof window.innerWidth?window.innerWidth:document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?document.documentElement.clientWidth:document.body&&(document.body.clientWidth||document.body.clientHeight)?document.body.clientWidth:1280},i.fn.cropimg=function(t){t=i.extend({maxContainerWidth:null,resultWidth:100,resultHeight:100,inputPrefix:"",zoomDelay:400,mouseWheelZoomTimes:10,zoomStep:1,showBtnTips:!0,displayZoomingButtons:!0,displayFixingPositionsButtons:!0,displayFixingSizeButtons:!0,btnTipsFadeTime:100,textBtnTipZoomIn:"Zoom in",textBtnTipZoomOut:"Zoom out",textBtnTipRTW:"Resize to container width",textBtnTipRTH:"Resize to container height",textBtnTipFPTL:"Move image to Top Left Corner",textBtnTipFPTC:"Move image to Top Center",textBtnTipFPTR:"Move image to Top Right Corner",textBtnTipFPCL:"Move image to Center Left",textBtnTipFPCC:"Move image to Center of container",textBtnTipFPCR:"Move image to Center Right",textBtnTipFPBL:"Move image to Bottom Left Corner",textBtnTipFPBC:"Move image to Bottom Center",textBtnTipFPBR:"Move image to Bottom Right Corner",onInit:function(){},onChange:function(i,t,n,a,o){}},t);var n=function(i,t){this.options=t,this.changed=!1,this.image=i,this.imageData={},this.container=null,this.imageContainer=null,this.imgCntData={width:-1},this.mt=(new Date).getTime()+Math.floor(1e3*Math.random()+1),this.vars={x:0,y:0,w:0,h:0},this.ToolDrawer=null,this.BtnTips=null,this.Movable=null,this.Zooming=null,this.CroppingResult=null,this.Reset=null},a=function(t){this.main=t,this.draw=function(){this.drawContainers(),this.main.options.displayZoomingButtons&&this.drawZoomingButtons(),this.main.options.displayFixingPositionsButtons&&this.drawFixingPositionButtons(),this.main.options.displayFixingSizeButtons&&this.drawFixingSizeButtons();var t=this;i(window).resize(function(i){t.onResize(t,i)})},this.drawContainers=function(){this.main.image.wrap(i("<div />",{"class":"ci-main",id:"ci-main-"+this.main.mt,style:"max-width:"+this.main.options.resultWidth+"px"})),this.main.container=i(".ci-main#ci-main-"+this.main.mt),this.main.image.wrap(i("<div />",{"class":"ci-image-wrapper",id:"ci-image-wrapper-"+this.main.mt,style:"max-width:"+this.main.options.resultWidth+"px;height:"+this.main.options.resultHeight+"px"})),this.main.imageContainer=i(".ci-image-wrapper#ci-image-wrapper-"+this.main.mt),this.main.container.append(i("<div />",{"class":"ci-tool ci-zooming"}))},this.drawZoomingButtons=function(){this.main.container.find(".ci-tool.ci-zooming").append(i("<span />",{title:this.main.options.textBtnTipZoomIn,href:"#","class":"ci-button ci-tool-zoomin"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipZoomOut,href:"#","class":"ci-button ci-tool-zoomout"}).click(function(){return!1}))},this.drawFixingPositionButtons=function(){this.main.imageContainer.append(i("<span />",{title:this.main.options.textBtnTipFPTL,href:"#","class":"ci-fixing-position ci-fptl"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPTC,href:"#","class":"ci-fixing-position ci-fptc"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPTR,href:"#","class":"ci-fixing-position ci-fptr"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPCL,href:"#","class":"ci-fixing-position ci-fpcl"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPCC,href:"#","class":"ci-fixing-position ci-fpcc"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPCR,href:"#","class":"ci-fixing-position ci-fpcr"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPBL,href:"#","class":"ci-fixing-position ci-fpbl"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPBC,href:"#","class":"ci-fixing-position ci-fpbc"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipFPBR,href:"#","class":"ci-fixing-position ci-fpbr"}).click(function(){return!1}))},this.drawFixingSizeButtons=function(){this.main.container.find(".ci-tool.ci-zooming").append(i("<span />",{title:this.main.options.textBtnTipRTW,href:"#","class":"ci-fixing-size ci-fsw"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipRTH,href:"#","class":"ci-fixing-size ci-fsh"}).click(function(){return!1}))},this.drawFixingSizeButtons=function(){this.main.container.find(".ci-tool.ci-zooming").append(i("<span />",{title:this.main.options.textBtnTipRTW,href:"#","class":"ci-fixing-size ci-fsw"}).click(function(){return!1})).append(i("<span />",{title:this.main.options.textBtnTipRTH,href:"#","class":"ci-fixing-size ci-fsh"}).click(function(){return!1}))},this.onResize=function(i,t){i.main.imageContainer.width()<i.main.options.resultWidth?(i.main.imgCntData.proportionsToOriginal=i.main.imageContainer.width()/i.main.options.resultWidth,i.main.imageContainer.css("height",i.main.options.resultHeight*i.main.imgCntData.proportionsToOriginal+"px"),i.main.imgCntData.width=i.main.imageContainer.width(),i.main.imgCntData.height=i.main.imageContainer.height(),i.main.CroppingResult.cropPercent=i.main.imgCntData.proportionsToOriginal):(i.main.imageContainer.css("height",i.main.options.resultHeight),i.main.imgCntData.width=i.main.imageContainer.width(),i.main.imgCntData.height=i.main.options.resultHeight,i.main.imgCntData.proportionsToOriginal=1),i.main.changed&&i.main.Zooming.eventMouseUp()}},o=function(t){this.main=t,this.currentTipId="",this.lastTipId="",this.init=function(){var t=this;return 0==this.main.options.showBtnTips?!1:void i("[title]",this.main.container).add(i("[title]",this.main.imageContainer)).each(function(){i(this).attr("data-txt",i(this).attr("title")).removeAttr("title").hover(function(){t.main.BtnTips.show(t,this)},function(){t.main.BtnTips.hide(t,this)})})},this.show=function(t,n){t.currentTipId="ci-tip-"+(new Date).getTime(),i("body").append(i('<span class="ci-tip" id="'+t.currentTipId+'">'+i(n).attr("data-txt")+"</span>").fadeTo(0,0).fadeTo(t.main.options.btnTipsFadeTime,1));var a=i(n).offset(),o=i("body").find(".ci-tip#"+t.currentTipId);o.css({left:a.left-o.outerWidth()/2+i(n).outerWidth()/2,top:a.top-o.outerHeight()-(i(n).outerHeight()-5)/2}),t.lastTipId=t.currentTipId},this.hide=function(){i("body").find(".ci-tip#"+this.lastTipId).hover(function(){i(this).remove()},i.noop).fadeTo(this.main.options.btnTipsFadeTime,0,function(){i(this).remove()})}},e=function(t){this.main=t,this.mousePositionStart={x:0,y:0},this.imagePosition={left:0,top:0},this.mouseDowned=!1,this.init=function(){var t=this;this.main.imageContainer.bind("mousedown",function(i){t.eventMouseDown(t,i)}),i("body").bind("mousemove",function(i){t.eventMouseMove(t,i)}).bind("mouseup",function(i){t.eventMouseUp(t,i)});var n=function(i){i.preventDefault()};this.main.imageContainer.find("img").bind("mousemove",n).bind("mouseup",n).bind("mousedown",n),this.bindFixingButtons()},this.eventMouseDown=function(i,t){i.mouseDowned===!1&&(i.mousePositionStart.x=t.pageX,i.mousePositionStart.y=t.pageY,i.imagePosition.left=parseInt(i.main.image.css("left").replace("px","")),i.imagePosition.top=parseInt(i.main.image.css("top").replace("px","")),i.main.changed=!0,i.mouseDowned=!0)},this.eventMouseUp=function(i,t){i.mouseDowned===!0&&(i.mouseDowned=!1,i.main.CroppingResult.update(parseInt(i.main.image.css("left").replace("px","")),parseInt(i.main.image.css("top").replace("px",""))),i.main.Zooming.eventMouseUp())},this.eventMouseMove=function(i,t){i.mouseDowned===!0&&(i.main.changed=!0,i.main.image.css(i.calculatePosition(t.pageX,t.pageY)))},this.bindFixingButtons=function(){var i=this;this.main.imageContainer.find(".ci-fixing-position.ci-fptl").mouseup(function(){i.main.image.css({top:"0px",left:"0px"}),i.main.vars.x=0,i.main.vars.y=0,i.main.CroppingResult.update(0,0)}),this.main.imageContainer.find(".ci-fixing-position.ci-fptc").mouseup(function(){var t=-(i.main.imageData.width/2-i.main.imgCntData.width/2);i.main.image.css({top:"0px",left:t+"px"}),i.main.vars.x=0,i.main.vars.y=t,i.main.CroppingResult.update(t,0)}),this.main.imageContainer.find(".ci-fixing-position.ci-fptr").mouseup(function(){var t=-(i.main.imageData.width-i.main.imgCntData.width);i.main.image.css({top:"0px",left:t+"px"}),i.main.vars.x=0,i.main.vars.y=t,i.main.CroppingResult.update(t,0)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpcl").mouseup(function(){var t=-(i.main.imageData.height/2-i.main.imgCntData.height/2);i.main.image.css({top:t+"px",left:"0px"}),i.main.vars.x=0,i.main.vars.y=t,i.main.CroppingResult.update(0,t)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpcc").mouseup(function(){var t=-(i.main.imageData.height/2-i.main.imgCntData.height/2),n=-(i.main.imageData.width/2-i.main.imgCntData.width/2);i.main.image.css({top:t+"px",left:n+"px"}),i.main.vars.x=n,i.main.vars.y=t,i.main.CroppingResult.update(n,t)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpcr").mouseup(function(){var t=-(i.main.imageData.height/2-i.main.imgCntData.height/2),n=-(i.main.imageData.width-i.main.imgCntData.width);i.main.image.css({top:t+"px",left:n+"px"}),i.main.vars.x=n,i.main.vars.y=t,i.main.CroppingResult.update(n,t)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpbl").mouseup(function(){var t=-(i.main.imageData.height-i.main.imgCntData.height);i.main.image.css({top:t+"px",left:"0px"}),i.main.vars.x=0,i.main.vars.y=t,i.main.CroppingResult.update(0,t)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpbc").mouseup(function(){var t=-(i.main.imageData.height-i.main.imgCntData.height),n=-(i.main.imageData.width/2-i.main.imgCntData.width/2);i.main.image.css({top:t+"px",left:n+"px"}),i.main.vars.x=n,i.main.vars.y=t,i.main.CroppingResult.update(n,t)}),this.main.imageContainer.find(".ci-fixing-position.ci-fpbr").mouseup(function(){var t=-(i.main.imageData.height-i.main.imgCntData.height),n=-(i.main.imageData.width-i.main.imgCntData.width);i.main.image.css({top:t+"px",left:n+"px"}),i.main.vars.x=n,i.main.vars.y=t,i.main.CroppingResult.update(n,t)})},this.calculatePosition=function(i,t){return{top:t-this.mousePositionStart.y+this.imagePosition.top,left:i-this.mousePositionStart.x+this.imagePosition.left}}},s=function(t){this.main=t,this.interval=null,this.timesLeftToZoom=10,this.canStopZoom=!1,this.zoomFunction=function(){},this.init=function(){var t=this;this.timesLeftToZoom=this.main.options.zoomDelay,this.main.container.find(".ci-tool.ci-zooming .ci-button").mousedown(function(){t.canStopZoom=!0,t.eventMouseDown(i(this).hasClass("ci-tool-zoomin")?"in":"out")}).mouseup(function(i){t.eventMouseUp(),t.canStopZoom=!1,i.stopPropagation()}).click(function(){t.canStopZoom=!1,t.eventMouseClick(i(this).hasClass("ci-tool-zoomin")?"in":"out")}),i("body").mouseup(function(){t.canStopZoom&&t.stopZoom()});var n=document.createElement("IMG");n.className="ci-image-loader",n.onload=function(){t.main.imageData={originalWidth:t.main.image.width(),originalHeight:t.main.image.height(),width:t.main.image.width(),height:t.main.image.height(),proportions:1},i(".ci-image-loader",t.main.imageContainer).remove()},n.src=this.main.image.attr("src"),this.main.imageContainer.append(n),this.bindFixingButtons(),"function"==typeof this.main.container.mousewheel&&this.main.container.mousewheel(function(i){for(var n=1==i.deltaY?"in":"out",a=0;a<t.main.options.mouseWheelZoomTimes;a++)t.zoom(n);return t.eventMouseUp(),i.stopPropagation(),i.preventDefault(),!1})},this.prepareToZoom=function(i){this.main.changed=!0,this.allowedZoomingFromInterval=!0,this.zoomFunction=function(){this.zoom(i)}},this.eventMouseDown=function(i){var t=this;return this.prepareToZoom(i),this.interval=setInterval(function(){t.timesLeftToZoom=t.timesLeftToZoom-10,t.timesLeftToZoom<=0&&t.zoomFunction()},10),!1},this.eventMouseUp=function(){this.main.CroppingResult.update(void 0,void 0,this.main.options.resultWidth*parseFloat(this.main.CroppingResult.cropPercent),this.main.options.resultHeight*parseFloat(this.main.CroppingResult.cropPercent),!0),this.stopZoom()},this.eventMouseClick=function(i){this.stopZoom(),this.prepareToZoom(i),this.zoomFunction()},this.stopZoom=function(){this.timesLeftToZoom=this.main.options.zoomDelay,clearInterval(this.interval)},this.zoom=function(i){"in"==i?this.main.imageData.proportions=(parseFloat(this.main.imageData.proportions)+this.main.options.zoomStep/1e3).toFixed(4):this.main.imageData.proportions=(parseFloat(this.main.imageData.proportions)-this.main.options.zoomStep/1e3).toFixed(4),this.main.imageData.proportions>=2&&(this.main.imageData.proportions=2),this.main.imageData.proportions<=.001&&(this.main.imageData.proportions=.001),this.main.imageData.width=this.main.imageData.originalWidth*this.main.imageData.proportions,this.main.imageData.height=this.main.imageData.originalHeight*this.main.imageData.proportions;var t=this.fixSizes(this.main.imageData.originalWidth*this.main.imageData.proportions,this.main.imageData.originalHeight*this.main.imageData.proportions);this.main.image.css({width:t.width,height:t.height,"max-width":t.width,"max-height":t.height,"min-width":t.width,"min-height":t.height})},this.bindFixingButtons=function(){var i=this,t=function(){i.main.imageData.width=i.main.imageData.originalWidth*i.main.imageData.proportions,i.main.imageData.height=i.main.imageData.originalHeight*i.main.imageData.proportions;var t=i.fixSizes(i.main.imageData.originalWidth*i.main.imageData.proportions,i.main.imageData.originalHeight*i.main.imageData.proportions);i.main.image.css({width:t.width,height:t.height,"max-width":t.width,"max-height":t.height,"min-width":t.width,"min-height":t.height}),i.main.CroppingResult.update(void 0,void 0,i.main.options.resultWidth*parseFloat(i.main.CroppingResult.cropPercent),i.main.options.resultHeight*parseFloat(i.main.CroppingResult.cropPercent),!0)};this.main.container.find(".ci-fixing-size.ci-fsw").click(function(){i.main.imageData.proportions=i.main.imageContainer.width()/i.main.imageData.originalWidth,t()}),this.main.container.find(".ci-fixing-size.ci-fsh").click(function(){i.main.imageData.proportions=i.main.imageContainer.height()/i.main.imageData.originalHeight,t()})},this.fixSizes=function(i,t){(0==i||0==t)&&(i=this.main.imageData.width,t=this.main.imageData.height);var n={width:this.main.options.resultWidth,height:this.main.options.resultHeight};if(this.main.options.restrictedBounds&&(n.width>i||n.height>t)){var a=n.width/i,o=n.height/t,e=0;e=a>o?a:o,i*=e,t*=e,this.main.Zooming.eventMouseUp()}return{width:i+"px",height:t+"px"}}},m=function(t){this.main=t,this.coordinates={x:0,y:0},this.cropPercent=1,this.update=function(t,n,a,o,e){var s=this.main.imageData.originalWidth/this.main.imageData.width,m=this.main.vars.x;void 0!=t?m=Math.ceil(s*t):""==m&&(m=0),t=m,i("#"+this.main.options.inputPrefix+"x").val(m),this.main.vars.x=m;var h=this.main.vars.y;void 0!=n?h=Math.ceil(s*n):""==h&&(h=0),n=h,i("#"+this.main.options.inputPrefix+"y").val(h),this.main.vars.y=h;var p=this.main.vars.w;void 0!=a?p=Math.ceil(s*a):""==p&&(p=0),a=p,i("#"+this.main.options.inputPrefix+"w").val(p),this.main.vars.w=p;var r=this.main.vars.h;void 0!=o?r=Math.ceil(s*o):""==r&&(r=0),o=r,i("#"+this.main.options.inputPrefix+"h").val(r),this.main.vars.h=r,e===!0&&this.main.options.onChange(this.main.vars.x,this.main.vars.y,this.main.vars.w,this.main.vars.h,this.main.image)}},h=function(i){this.main=i,this.reset=function(){var i=this.main.image.clone().removeAttr("style");this.main.container.replaceWith(i),i.data("cropimg",null)}};return this.each(function(){var p=new n(i(this),t);p.ToolDrawer=new a(p),p.BtnTips=new o(p),p.Movable=new e(p),p.Zooming=new s(p),p.CroppingResult=new m(p),p.Reset=new h(p),p.ToolDrawer.draw(),p.BtnTips.init(),p.Movable.init(),p.Zooming.init(),i(this).data("cropimg",p.Reset),i(window).trigger("resize"),t.onInit()})}}(jQuery);
